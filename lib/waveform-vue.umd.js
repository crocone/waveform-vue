(function(l,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],a):(l=typeof globalThis<"u"?globalThis:l||self,a(l["1llest-waveform-vue"]={},l.Vue))})(this,function(l,a){"use strict";var j=Object.defineProperty;var X=(l,a,f)=>a in l?j(l,a,{enumerable:!0,configurable:!0,writable:!0,value:f}):l[a]=f;var n=(l,a,f)=>(X(l,typeof a!="symbol"?a+"":a,f),f);class f{constructor(e,t,i){n(this,"canvasCtx");var s;this.canvas=e,this.props=t,this.filteredData=i,this.canvas=e,this.canvasCtx=(s=this.canvas)==null?void 0:s.getContext("2d"),this.props=t,this.filteredData=i}get _canvas(){return this.canvas}set _props(e){this.props=e}get _props(){return this.props}setupCanvas(){this.setCanvasBase(),this.translateCanvasCtx(),this.drawCanvasLines()}setCanvasBase(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.canvas.style.opacity="1",this.canvasCtx.fillStyle="transparent",this.canvasCtx.fillRect(0,0,this.canvas.width,this.canvas.height)}translateCanvasCtx(){this.canvasCtx.translate(this.canvas.width/this.filteredData.length,this.canvas.height/2-this.canvas.height/2)}drawCanvasLines(){const{canvas:e,canvasCtx:t,filteredData:i}=this;i.forEach((s,p)=>{const m=e.width/i.length,y=m*p-m/2;t.moveTo(y,e.height/2-Math.abs(s)*e.height*.4),t.lineTo(y,e.height/2+Math.abs(s)*e.height*.4)})}drawMask(e){const{canvas:t,canvasCtx:i,props:s}=this;i.globalCompositeOperation="destination-atop",i.fillStyle=s.maskColor,i.fillRect(0,0,e,t.height)}drawWave(){const{canvasCtx:e,props:t}=this;e.lineWidth=t.lineWidth,e.lineCap=t.lineCap,e.strokeStyle=t.lineColor,e.stroke()}setWaveStyle(e){const{canvas:t,canvasCtx:i}=this;i.clearRect(0,0,t.width,t.height),this.drawMask(e),this.drawWave()}}class b{constructor(e){n(this,"props");n(this,"audioCtx");n(this,"audioBuffer");n(this,"gainNode");n(this,"mediaEl");n(this,"mediaSrcNode");n(this,"playbackRate");n(this,"filteredData");n(this,"arrayBuffer");this.props=e,this.audioCtx=new AudioContext,this.playbackRate=1}get _filteredData(){return this.filteredData}get _audioDuration(){if(!this.audioBuffer)throw new Error("can not get duration before audio inited");return this.audioBuffer.duration}async setupAudio(){await this.createAudioBuffer(),this.createFilterData(),this.createGainNode(),await this.initWithMediaElement(this.props.url,!1)}async fetchAudioFile(){try{const e=await fetch(this.props.url,this.props.requestOptions);this.arrayBuffer=await e.arrayBuffer()}catch(e){console.error(e)}}async createAudioBuffer(){this.audioBuffer=await this.audioCtx.decodeAudioData(this.arrayBuffer)}createGainNode(){this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.setValueAtTime(0,this.audioCtx.currentTime)}async initWithMediaElement(e,t=!0){this.disposeMedia();const i=new Audio;i.src=e,i.preload="auto",i.crossOrigin="anonymous",i.preservesPitch=!0,i.mozPreservesPitch=!0,i.webkitPreservesPitch=!0,i.playbackRate=this.playbackRate;const s=this.audioCtx.createMediaElementSource(i);t&&(s.connect(this.gainNode),this.gainNode.connect(this.audioCtx.destination)),typeof i.load=="function"&&i.load(),this.mediaEl=i,this.mediaSrcNode=s}setPlaybackRate(e){this.playbackRate=e,this.mediaEl&&(this.mediaEl.playbackRate=e)}disposeMedia(){var e;try{(e=this.mediaSrcNode)==null||e.disconnect()}catch{}this.mediaSrcNode=void 0,this.mediaEl&&(this.mediaEl.pause(),this.mediaEl.src="",typeof this.mediaEl.load=="function"&&this.mediaEl.load()),this.mediaEl=void 0}createFilterData(){const e=this.props.samplingRate,t=[],i=this.audioBuffer.getChannelData(0);for(let s=0;s<e;s++){const p=Math.floor(i.length/e),m=i[s*p];t.push(m)}this.filteredData=t}}function C(o){return new Promise(e=>setTimeout(e,o))}class D extends b{constructor(t){super(t);n(this,"startAt");n(this,"pauseAt");n(this,"pickAt");n(this,"playing");n(this,"audioBufferSourceNode");n(this,"FADE_DURATION");this.startAt=0,this.pauseAt=0,this.pickAt=0,this.playing=!1,this.FADE_DURATION=this.props.fade?.08:0}get _playing(){return this.playing}get _currentTime(){return this.mediaEl?this.mediaEl.currentTime:this.pauseAt?this.pauseAt:this.startAt?this.audioCtx.currentTime-this.startAt:this.audioCtx.currentTime}play(){if(this.mediaEl){this.playWithMediaElement();return}this.disconnectDestination(),this.createAudioBufferSourceNode(),this.connectDestination();const t=this.pickAt?this.pickAt:this.pauseAt;this.audioBufferSourceNode.start(0,t),this.startAt=this.audioCtx.currentTime-t,this.pauseAt=0,this.playing=!0,this.props.fade?(this.setGainValue(0),this.setGainLinearRamp(1)):this.setGainValue(1)}async pause(){if(this.mediaEl){await this.pauseWithMediaElement();return}const t=this.audioCtx.currentTime-this.startAt;this.props.fade&&(this.setGainLinearRamp(0),await C(this.FADE_DURATION*1e3)),this.disconnectDestination(),this.initializeState(),this.pauseAt=t+this.FADE_DURATION}pick(t){if(this.pickAt=t,this.mediaEl){if(this.mediaEl.currentTime=t,!this.playing){this.pauseAt=t;return}return}!this.playing||(this.disconnectDestination(),this.play())}replay(){if(this.mediaEl){this.mediaEl.currentTime=0,this.pauseAt=0,this.pickAt=0,this.playWithMediaElement();return}this.audioBufferSourceNode&&(this.disconnectDestination(),this.initializeState()),this.play()}finish(){if(this.pauseAt=0,this.mediaEl){this.mediaEl.pause(),this.mediaEl.currentTime=0,this.disconnectDestination(),this.initializeState();return}this.disconnectDestination(),this.initializeState()}setPlaybackRate(t){super.setPlaybackRate(t),this.audioBufferSourceNode&&(this.audioBufferSourceNode.playbackRate.value=t,this.mediaEl||console.warn("[Audio] setPlaybackRate via buffer path \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442 \u043F\u0438\u0442\u0447"))}initializeState(){this.playing=!1,this.startAt=0,this.pauseAt=0,this.pickAt=0}createAudioBufferSourceNode(){this.audioBufferSourceNode||(this.audioBufferSourceNode=this.audioCtx.createBufferSource(),this.audioBufferSourceNode.buffer=this.audioBuffer,this.audioBufferSourceNode.playbackRate.value=this.playbackRate)}connectDestination(){if(this.mediaSrcNode){this.mediaSrcNode.connect(this.gainNode),this.gainNode.connect(this.audioCtx.destination);return}!this.audioBufferSourceNode||(this.audioBufferSourceNode.connect(this.gainNode),this.gainNode.connect(this.audioCtx.destination))}disconnectDestination(){if(this.mediaSrcNode){try{this.mediaSrcNode.disconnect(),this.gainNode.disconnect()}catch{}return}!this.audioBufferSourceNode||(this.audioBufferSourceNode.disconnect(),this.audioBufferSourceNode.stop(),this.audioBufferSourceNode=null)}setGainValue(t){this.gainNode.gain.setValueAtTime(t,this.audioCtx.currentTime)}setGainLinearRamp(t){this.gainNode.gain.linearRampToValueAtTime(t,this.audioCtx.currentTime+this.FADE_DURATION)}playWithMediaElement(){if(!this.mediaEl)return;const t=this.pickAt?this.pickAt:this.pauseAt;t&&(this.mediaEl.currentTime=t),this.disconnectDestination(),this.connectDestination();const i=this.mediaEl.play();this.startAt=this.audioCtx.currentTime-t,this.pauseAt=0,this.playing=!0,this.props.fade?(this.setGainValue(0),this.setGainLinearRamp(1)):this.setGainValue(1),i.catch(s=>{console.error("[Audio] Failed to play media element",s)})}async pauseWithMediaElement(){if(!this.mediaEl)return;this.props.fade&&(this.setGainLinearRamp(0),await C(this.FADE_DURATION*1e3)),this.mediaEl.pause();const t=this.mediaEl.currentTime;this.disconnectDestination(),this.initializeState(),this.pauseAt=t}}function E(o){const e=Math.floor(o/60),t=Math.floor(o%60);return`${e}:${t<10?"0":""}${t}`}class S{constructor(e,t){n(this,"el");n(this,"handler");n(this,"intersectionObserver");n(this,"timer");n(this,"rended");this.el=e,this.handler=t,this.timer=null,this.rended=!1}observe(){const e=t=>{if(this.rended)return this.unobserve();const i=t[0],s=260;i.intersectionRatio>0?this.timer=setTimeout(()=>{this.handler(),this.rended=!0},s):this.timer&&(clearTimeout(this.timer),this.timer=null)};this.intersectionObserver=new IntersectionObserver(e),this.intersectionObserver.observe(this.el)}unobserve(){this.intersectionObserver.unobserve(this.el)}}let A;function x(o,e){A=new S(o,e),A.observe()}function R(){A.unobserve()}const T=a.defineComponent({__name:"IllestWaveform",props:{url:{},requestOptions:{default:()=>({})},lineWidth:{default:.5},lineCap:{default:"round"},lineColor:{default:"#5e5e5e"},samplingRate:{default:22050},cursorWidth:{default:2},cursorColor:{default:"#fff"},maskColor:{default:"#fff"},lazy:{type:[Boolean,Object],default:!0},skeleton:{type:[Boolean,Object],default:!0},skeletonColor:{default:"#232323"},interact:{type:[Boolean,Object],default:!0},fade:{type:[Boolean,Object],default:!0}},emits:["onInit","onFetched","onReady","onPlay","onPause","onFinish","onClick"],setup(o,{expose:e,emit:t}){const i=o,s=a.ref(!1),p=a.ref(null);a.onMounted(async()=>{i.lazy?(x(p.value,m),a.watchEffect(async()=>{s.value&&await N()})):await N()}),a.onUnmounted(()=>{i.lazy&&R(),r&&r.pause()});function m(){s.value=!0}const y=a.ref(null),h=a.ref(!1);let r,d;async function N(){h.value||(u("onInit",!0),await W(),await M(),h.value=!0,u("onReady",h.value))}async function W(){r=new D(i),await r.fetchAudioFile(),u("onFetched",!0),await r.setupAudio(),G()}async function M(){d=new f(y.value,i,r._filteredData),d.setupCanvas(),a.watchEffect(()=>{d._props=i,d.setWaveStyle(g.value)})}const v=a.ref(0),_=a.ref(0),g=a.ref(0);function w(){!r._playing||(requestAnimationFrame(w),_.value=r._currentTime,g.value=_.value/r._audioDuration*d._canvas.width)}function F(c){!h.value||!i.interact||(c.layerX<=0?v.value=0:c.layerX>=d._canvas.width?v.value=d._canvas.width:v.value=c.layerX)}function O(){if(!h.value||!i.interact)return;g.value=v.value;const c=v.value/d._canvas.width*r._audioDuration;r.pick(c),_.value=c,u("onClick",p),u("onFinish",!1)}function P(){!h.value||(r.play(),u("onPlay",!0),w())}function z(){r.replay(),u("onFinish",!1),u("onPlay",!0),w()}function I(){r.pause(),u("onPause",!1)}function L(){r.finish(),u("onPlay",!1),u("onFinish",!0)}function V(c){r.setPlaybackRate(c)}function G(){a.watchEffect(()=>{_.value<=r._audioDuration||L()})}function $(){return E(_.value)}function U(){const c=r._audioDuration;return E(c)}const u=t;return e({play:P,pause:I,replay:z,getCurrentTime:$,getDuration:U,setPlaybackRate:V}),(c,Y)=>(a.openBlock(),a.createElementBlock("section",{id:"illest-waveform",ref_key:"__illestWaveformRef__",ref:p,style:a.normalizeStyle(`${h.value&&o.interact?"cursor: pointer":""}`),onMousemove:F,onClick:O},[a.createVNode(a.Transition,{name:"fade"},{default:a.withCtx(()=>[a.withDirectives(a.createElementVNode("div",{id:"illest-waveform__skeleton",style:a.normalizeStyle(`background-color: ${o.skeletonColor}`)},[a.withDirectives(a.createElementVNode("div",{id:"illest-waveform__skeleton__load",style:a.normalizeStyle(`background-color: ${o.skeletonColor}`)},null,4),[[a.vShow,!h.value]])],4),[[a.vShow,i.skeleton&&!h.value]])]),_:1}),a.createElementVNode("canvas",{id:"illest-waveform__view",ref_key:"waveRef",ref:y},null,512),a.withDirectives(a.createElementVNode("div",{id:"illest-waveform__cursor",style:a.normalizeStyle(`width:${i.cursorWidth}px; transform: translateX(${v.value}px);background-color: ${i.cursorColor}; `)},null,4),[[a.vShow,h.value&&i.interact]])],36))}}),q="",k=((o,e)=>{const t=o.__vccOpts||o;for(const[i,s]of e)t[i]=s;return t})(T,[["__scopeId","data-v-04478eb9"]]),B={install:o=>{o.component("IllestWaveform",k)}};l.IllestWaveform=k,l.default=B,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
